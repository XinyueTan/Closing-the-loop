---
title: "Closing the Loop"
author: "Charles Lang"
date: "1/29/2018"
output: html_document
---

## Twitter Setup

Step 1. Create a Twitter account at Twitter.com and register as a developer at the following link: https://developer.twitter.com/

Step 2. Register a new app (we need to create an app to access the API as that is what the primary us of the API is) at https://apps.twitter.com/

Step 3. Within R, I install the packages ROAuth and twitteR

Step 4. Copy the following details from my Twitter App page. 

```{r}
library(ROAuth)
library(twitteR)

api_key <- "oJmaXqsNboFYxUt2azdJaVd7p"

api_secret <- "N2aYLWg2r1An9d9VZExFCTjMpzRSQEh9DoUDz5osRryq7kQ2VN"

access_token <- "828337321137360897-eUO0iBDUWgkoHTFz7WGSVOnPa5IXhMI"

access_token_secret <- "xxot2hPTlGexnDR8fEpn99OIyrgCsVAz1a88IPk3GQb8J"

setup_twitter_oauth(api_key, api_secret, access_token, access_token_secret)
```

I now download Tweets from the previous 6-7 days. Limit the number of tweets I are searching for using `n=`

### Download Tweets
```{r}
library(ROAuth)
library(twitteR)

TL <- searchTwitter("education data", n=50, since='2019-04-19', until='2019-04-25')

# Change the dates here to be 6 days from today.
TL <- do.call("rbind", lapply(TL, as.data.frame))
save(TL, file = "TL.RData")
#load("TL.RData")

```

Look at the data that Twitter has made available and do a quick visualization of Tweets over time.

```{r}
counts=table(TL$screenName)
barplot(counts, las=2)

#By time of day
hist(TL$created, breaks = "d")
```

```{r}
ggplot(TL, aes(x=created, y=retweetCount))+
  geom_line()

```


## Setup auto-email

To set up an autogenerated email, I will need to install both the sendmailR and cronR packages. The cronR package is a scheduling package that connects to the cron system on my computer while sendmailR gives me access to my gmail account. I have to change the security settings on my gmail account to make this package work.

```{r}
install.packages("sendmailR")
install.packages("cronR")
library(sendmailR)
library(cronR)
library(twitteR)
library(RCurl)
library(ROAuth)



#Email  
sendmail_options(smtpServer="ASPMX.L.GOOGLE.COM")
address <- as.character("xt2213@tc.columbia.edu")
address <- paste("<", address, ">", sep = "")


from <- "<xt2213@tc.columbia.edu>"
to <- address
subject <- "Twitter data visualization"
body <- c(
  "Latest Twitter notification."
)

sendmail(from, to, subject, body)


```

Investigate the Chron Scheduler 

Windows users: Can use the built-in Task Scheduler application:

https://rstudio-pubs-static.s3.amazonaws.com/197242_31c29cf17f2c424d83d23bdc52a18c70.html

Use the scheduler to schedule an email to myself

## Threshold Generate

Set the scheduler to send an email triggered by an activity threshold on Twitter. For example, an email is sent if a certain number of Tweets are returned by my search.


```{r}
notify <- function() {
        if (nrow(TL) > 100){
          reminder = mime() 
                from("ASPMX.L.GOOGLE.COM")
                to("xt22138@tc.columbia.edu")
                subject("tweets exceed 1000")
                text_body("There are more than 1000 relevant tweets about the topic education data ") 
                send_message()      
        } else {
         return (paste('we are keeping an eye on your data, and we will notify you when your search condition is met'))       
        }
}
notify()
```